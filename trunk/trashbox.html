<!DOCTYPE html>
<head>
	<title>宝贝下线助手</title>
	<link type="text/css" rel="stylesheet" href="css/style.css" />
	<script type="text/javascript" src="js/jquery.1.6.2.min.js"></script>
	<script type="text/javascript" src="js/assistant.js"></script>
</head>
<body>

<script type="text/javascript">
// 读取插件配置
var options = assistant.getOptions();

//添加所有已选宝贝到垃圾箱
function addItems() {
	jQuery('#datalist tr:has(td)').remove();

	// 从Background页抽取以选中的数据
	var selected = chrome.extension.getBackgroundPage().selected;
	var selectedNids = [];
	for (var nid in selected) {
		if (selected[nid] !== null) {
			selectedNids.push(nid);
		}
	}

	if (selectedNids.length === 0) {
		assistant.notify('未找到任何选中的宝贝,请重试!', 'success', onAddComplete);
		return false;
	}

	jQuery("#datalist").show();

	var current = 0;
	addItem();


	// 添加1个宝贝到垃圾箱
	function addItem() {

		if (current === selectedNids.length) {
			jQuery("table.datalist tbody tr:nth-child(even)").addClass("altrow");
			jQuery("table.datalist tbody tr").hover(function () {
				jQuery(this).addClass('highlight');
			}, function () {
				jQuery(this).removeClass('highlight');
			});

			assistant.notify('共找到' + current + '个待下架的宝贝', 'success');

			return false;
		}

		var item = selected[selectedNids[current]];
		var close = jQuery('<a href="javascript:void(0)" title="不下架该宝贝">删除</a>').click(function () {
			jQuery(this).parents('tr').remove();
			if (jQuery('#datalist tr:has(td)').size() === 0) {
				jQuery('#datalist').hide();
			}
		});

		jQuery('<tr/>')
			.attr('id', item.nid)
			.append(jQuery('<td/>').text(item.nid))
			.append(jQuery('<td/>').html('<a target="_blank" href="' + item.url + '">' + item.title + '</a>' ))
			.append(jQuery('<td class="actions"/>').append(close))
			.appendTo(jQuery('#datalist tbody'));

		setTimeout(function () {
			current++;
			addItem();
		}, 120);
	}
}

// 递归提交所有的下架请求
function submitItems() {
	var memo = jQuery('#memo').val();
	if (memo == '') {
		assistant.notify('请输入下架这些宝贝的原因', 'error');
		return false;
	}

	unregisterCallbacks();

	if (options.auto_memo === 'true') {
		setLastMemo(memo);
	}

	var server = options.server_url;
	var selected = jQuery('tbody tr');

	var current = 0;
	submitItem();

	// 提交单个的宝贝下架请求, 每次Ajax结束后都会对当前状态调整
	function submitItem() {
		if (current === selected.length) {
			assistant.notify('所有的宝贝下架条目已处理完毕!', 'success', onSubmitComplete);
			registerCallbacks();
			return false;
		}

		var item = jQuery(selected[current]);
		var nid = item.attr('id');
		var loader = jQuery('<span class="loader">&nbsp;</span>').hide();

		item.find('td.actions').empty().append(loader);

		jQuery.ajax({
			url: server,
			data: {
				c: 'auction_offlines',
				f: 'add',
				nid: nid,
				memo: memo,
				ajax: 1
			},
			method: 'POST',
			dataType: 'json',
			beforeSend: function () {
				loader.show();
			},
			complete: function (response) {
				try {
					var json = JSON.parse(response.responseText);
				} catch (error) {
					assistant.notify('可能因为您未在当前浏览器中登录到工具中,请登录后重试!', 'error');
					item.find('td.actions').text('出错啦');
					return false;
				}

				loader.removeClass('loader').addClass('icon');
				loader.addClass(json.status ? 'accept' : 'block');
				item.find('td.actions').append(json.code);

				setTimeout(function () {
					current++;
					submitItem();
				}, 250);
			}
		});
	}

	// 所有请求处理完毕之后给出提示, 回到SRP页
	function onSubmitComplete() {
		chrome.tabs.getSelected(null, function (tab) {
			var selectedIndex = chrome.extension.getBackgroundPage().selectedIndex;
			chrome.extension.getBackgroundPage().resetCheckBoxes();
			if (selectedIndex !== null) {
				chrome.tabs.update(selectedIndex, {selected: true});
			}
			chrome.tabs.remove(tab.id, function () { });
		});
	}
}

// 注册按钮回调
function registerCallbacks() {
	jQuery('#submit').click(submitItems).removeClass('disabled');
	jQuery('#extract').click(addItems).removeClass('disabled');
}

// 取消按钮回调
function unregisterCallbacks() {
	jQuery('#submit, #extract').unbind('click').addClass('disabled');
}

// 读取上次的下架原因
function getLastMemo() {
	var memo = window.localStorage.getItem('memo');
	if (memo !== null) {
		jQuery('#memo').text(memo);
	}
}

// 设置上次的下架原因到textarea
function setLastMemo(memo) {
	return window.localStorage.setItem('memo', memo);
}

// 页面加载后自动抽取NID
jQuery(document).ready(function () {
	registerCallbacks();
	if (options.auto_extract === 'true') {
		addItems();
	}
	if (options.auto_memo === 'true') {
		getLastMemo();
	}
});

</script>

<div class="trashbox main">

	<div class="header">
		<a href="javascript:void(0)" id="extract" class="button">抽取宝贝</a>
		<textarea id="memo" placeholder="请输入下架这些宝贝的原因"></textarea>
		<a href="javascript:void(0)" id="submit" class="button current">下架所有</a>
	</div>

	<table class="datalist" id="datalist" style="display:none;">
		<thead>
			<tr>
				<th width="18%">宝贝NID</th>
				<th width="60%">宝贝标题</th>
				<th width="22%">操作</th>
			</tr>
		</thead>
		<tbody>
		</tbody>
	</table>

	<p class="footer">宝贝下架助手 v1.0 by <a href="mailto:wangshijun2010@gmail.com">wangshijun2010@gmail.com</a></p>

</div>

</body>
</html>