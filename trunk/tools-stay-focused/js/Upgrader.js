
var Upgrader=function(){return{currentVersion:null,upgradeStack:[],init:function(){this.loadManifest();},loadManifest:function(){$.ajax({type:'GET',url:chrome.extension.getURL('manifest.json'),data:null,success:function(response){var manifest=JSON.parse(response);Upgrader.currentVersion=manifest.version;Upgrader.loadUpgrades();}});},loadUpgrades:function(){$.ajax({type:'GET',url:chrome.extension.getURL('js/upgrades/upgrades.json'),data:null,success:function(response){var upgrades=JSON.parse(response);if(Upgrader.isNewVersion()){Upgrader.upgradeStack=Upgrader.buildUpgradeStack(upgrades['versions']);Upgrader.doNextUpgrade();}}});},buildUpgradeStack:function(versions){var lastVersion=this.getLastVersion();var currentVersion=this.getCurrentVersion();var addToUpgradeStack=false;var upgradeStack=[];for(version in versions){addToUpgradeStack=version>lastVersion&&version<=currentVersion;if(addToUpgradeStack&&typeof versions[version]!='function'){upgradeStack.push(versions[version]);}}
return upgradeStack;},doNextUpgrade:function(){var nextUpgrade=this.upgradeStack.shift();if(nextUpgrade){this.doUpgrade(nextUpgrade);}else{this.endUpgrades();}},doUpgrade:function(upgradeFileName){if(upgradeFileName==undefined){this.doNextUpgrade();}else{$.getScript('js/upgrades/'+upgradeFileName,function(){Upgrader.doNextUpgrade();});}},endUpgrades:function(){this.setLocal('version',this.getCurrentVersion());},getCurrentVersion:function(){return this.currentVersion;},getLastVersion:function(){return this.getLocal('version');},isNewVersion:function(){var currentVersion=this.getCurrentVersion();var lastVersion=this.getLastVersion();return currentVersion!==lastVersion;},setLocal:function(name,value){localStorage.setItem(name,value);},getLocal:function(name){return localStorage.getItem(name);},removeLocal:function(name){return localStorage.removeItem(name);}}}();function bg(){return chrome.extension.getBackgroundPage();}