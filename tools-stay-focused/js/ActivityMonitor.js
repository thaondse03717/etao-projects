
var ActivityMonitor=function(){return{timer:null,interval:10,elapsedTime:0,maxInactiveTime:300,isOverlayActive:false,isBlockable:false,currentTabID:null,currentURL:null,initContentScript:function(){chrome.extension.sendRequest({'message':'isBlockable'},function(response){ActivityMonitor.isBlockable=response.isBlockable&&!response.isDisabled;if(ActivityMonitor.isBlockable===true){$('body').prepend(ActivityMonitor.getBlockerHTML());ActivityMonitor.startTimer();ActivityMonitor.bindTimerReset('body');$('body').keydown(function(){if(ActivityMonitor.isOverlayActive===true){ActivityMonitor.hideOverlay();event.preventDefault();}});$('#StayFocusd-unblock-link').click(function(){if(ActivityMonitor.isOverlayActive===true){ActivityMonitor.hideOverlay();}});$('iframe').each(function(){ActivityMonitor.bindTimerReset($(this).contents().find('body'));});}});},bindTimerReset:function(element){$(element).mousedown(function(){ActivityMonitor.resetTimer();});$(element).mousemove(function(){ActivityMonitor.resetTimer();});$(element).keypress(function(){ActivityMonitor.resetTimer();});},handleContentScriptRequest:function(request,sender){var response={};switch(request.message){case"isBlockable":response={'isBlockable':StayFocusd.isBlockable(sender.tab.url),'isDisabled':StayFocusd.isActivityMonitorDisabled()};break;case"stopCountdown":response={'countdownStopped':clearInterval(StayFocusd.timer)};break;case"startCountdown":response={'countdownStarted':null};break;default:response=null;break;}
return response;},initBackgroundScript:function(){chrome.tabs.onSelectionChanged.addListener(function(tabId,selectInfo){chrome.tabs.getSelected(null,function(tab){if(tab!==undefined){if(ActivityMonitor.currentTabID!=null){chrome.tabs.sendRequest(ActivityMonitor.currentTabID,{'message':'stopTimer'});}
ActivityMonitor.currentTabID=tab.id;ActivityMonitor.currentURL=tab.url;chrome.tabs.sendRequest(ActivityMonitor.currentTabID,{'message':'resetTimer'});chrome.tabs.sendRequest(ActivityMonitor.currentTabID,{'message':'hideOverlay'});if(StayFocusd.isBlockable(ActivityMonitor.currentURL)){chrome.tabs.sendRequest(ActivityMonitor.currentTabID,{'message':'startTimer'});}}});});chrome.extension.onRequest.addListener(function(request,sender,sendResponse){var response=ActivityMonitor.handleContentScriptRequest(request,sender);if(response!==null){sendResponse(response);}});},handleBackgroundScriptRequest:function(request,sender){var response={};switch(request.message){case"stopTimer":response={'timerStopped':ActivityMonitor.stopTimer()};break;case"startTimer":response={'timerStarted':ActivityMonitor.startTimer()};break;case"resetTimer":response={'timerReset':ActivityMonitor.resetTimer()};break;case"hideOverlay":response={'overlayHidden':ActivityMonitor.hideOverlay()};break;case"showOverlay":response={'overlayShown':ActivityMonitor.showOverlay(request.overlayType)};break;case"getReferrer":response={'referrer':document.referrer};break;case"killPage":top.location.href=request.redirectURL+'?content';response={'killed':true};break;default:response=null;break;}
return response;},startTimer:function(){clearInterval(this.timer);this.timer=setInterval('ActivityMonitor_tick()',(ActivityMonitor.interval*1000));},stopTimer:function(){clearInterval(this.timer);},resetTimer:function(){this.elapsedTime=0;},isMaxInactiveTimeExceeded:function(){return this.elapsedTime>=this.maxInactiveTime;},showOverlay:function(overlayType){$('embed').addClass('StayFocusd-hidden');$('object').addClass('StayFocusd-hidden');$('applet').addClass('StayFocusd-hidden');$('#StayFocusd-overlayHeader').html('Hey, you still there?');$('#StayFocusd-overlayBody').html("You've been inactive for a while. We stopped your StayFocusd countdown so you don't burn up all your time while you're away.");$('#StayFocusd-still-there').css('top',$(window).scrollTop()+"px");$('#StayFocusd-still-there').removeClass('inactive').addClass('active');this.isOverlayActive=true;this.stopTimer();chrome.extension.sendRequest({'message':'stopCountdown'});},hideOverlay:function(){if(this.isOverlayActive===true){$('#StayFocusd-still-there').removeClass('active').addClass('inactive');$('embed').removeClass('StayFocusd-hidden');$('object').removeClass('StayFocusd-hidden');$('applet').removeClass('StayFocusd-hidden');this.isOverlayActive=false;this.resetTimer();this.startTimer();chrome.extension.sendRequest({'message':'startCountdown'});}},getBlockerHTML:function(){var block='<link rel="stylesheet" href="'+chrome.extension.getURL('css/content.css')+'" type="text/css" />';block+='<div id="StayFocusd-still-there" class="inactive">';block+='<div>';block+='<img src="'+chrome.extension.getURL('img/logo_full.png')+'" title="StayFocusd" alt="StayFocusd" class="StayFocusd-smartBombed" />';block+='</div>';block+='<h1 id="StayFocusd-overlayHeader"></h1>';block+='<p id="StayFocusd-overlayBody"></p>';block+='<p>';block+='<b>Press any key or <a href="javascript:void(0)" id="StayFocusd-unblock-link" title="Click to access site">click here</a> to continue</b>';block+='</p>';block+='</div>';return block;}}}();function ActivityMonitor_tick(){ActivityMonitor.elapsedTime+=ActivityMonitor.interval;if(ActivityMonitor.isMaxInactiveTimeExceeded()){ActivityMonitor.showOverlay('away');}}