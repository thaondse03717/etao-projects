<!DOCTYPE html>
<head>
	<link type="text/css" rel="stylesheet" href="css/style.css" />
	<script type="text/javascript" src="js/jquery.1.6.2.min.js"></script>
</head>
<body>

<script type="text/javascript">

//添加所有已选宝贝到垃圾箱
function addItems() {
	$('#datalist tr:has(td)').remove();

	// 从Background页抽取以选中的数据
	var selected = chrome.extension.getBackgroundPage().selected;
	var selectedNids = [];
	for (var nid in selected) {
		if (selected[nid] !== null) {
			selectedNids.push(nid);
		}
	}

	if (selectedNids.length === 0) {
		showMessage('未找到任何选中的宝贝,请重试!', 'success', onAddComplete);
		return false;
	}

	var current = 0;
	addItem();


	// 添加1个宝贝到垃圾箱
	function addItem() {
		if (current === selectedNids.length) {
			showMessage('共找到' + current + '个待下架的宝贝', 'success', onAddComplete);
			return false;
		}

		var item = selected[selectedNids[current]];
		var close = $('<a href="javascript:void(0)" title="不下架该宝贝">删除</a>').click(function () {
			$(this).parents('tr').remove();
			if ($('#datalist tr:has(td)').size() === 0) {
				$('#datalist').hide();
			}
		});

		$('<tr/>')
			.attr('id', item.nid)
			.append($('<td/>').text(item.nid))
			.append($('<td/>').html('<a target="_blank" href="' + item.url + '">' + item.title + '</a>' ))
			.append($('<td class="actions"/>').append(close))
			.appendTo($('#datalist tbody'));

		setTimeout(function () {
			current++;
			addItem();
		}, 100);
	}

	// 表格隔行变色
	function onAddComplete() {
		$("table.datalist tbody tr:nth-child(even)").addClass("altrow");
		$("table.datalist tbody tr").hover(function () {
			$(this).addClass('highlight');
		}, function () {
			$(this).removeClass('highlight');
		});

		$("table.datalist").show();
	}
}

// 递归提交所有的下架请求
function submitItems() {
	var memo = $('#memo').val();
	if (memo == '') {
		showMessage('请输入下架这些宝贝的原因', 'error');
		return false;
	}

	$('#submit').click(function () {
		return false;
	});

	var host = 'http://eharmony.taobao.com/eharmony/';
	var selected = $('tbody tr');

	var current = 0;
	submitItem();

	// 提交单个的宝贝下架请求, 每次Ajax结束后都会对当前状态调整
	function submitItem() {
		if (current === selected.length) {
			showMessage('所有的请求已处理完毕!', 'success', onSubmitComplete);
			return false;
		}

		var item = $(selected[current]);
		var nid = item.attr('id');
		var loader = $('<span class="loader">&nbsp;</span>').hide();

		item.find('td.actions').empty().append(loader);

		$.ajax({
			url: host,
			data: {
				c: 'auction_offlines',
				f: 'add',
				nid: nid,
				memo: memo,
				ajax: 1
			},
			method: 'POST',
			dataType: 'json',
			beforeSend: function () {
				loader.show();
			},
			complete: function (response) {
				var json = JSON.parse(response.responseText);
				loader.removeClass('loader').addClass('icon');
				loader.addClass(json.status ? 'accept' : 'block');
				item.find('td.actions').append(json.code);
				setTimeout(function () {
					current++;
					submitItem();
				}, 250);
			}
		});
	}

	// 所有请求处理完毕之后给出提示, 回到SRP页
	function onSubmitComplete() {
		chrome.tabs.getSelected(null, function (tab) {
			var selectedIndex = chrome.extension.getBackgroundPage().selectedIndex;
			chrome.extension.getBackgroundPage().resetCheckBoxes();
			if (selectedIndex !== null) {
				chrome.tabs.update(selectedIndex, {selected: true});
			}
			chrome.tabs.remove(tab.id, function () { });
		});
	}
}

// 系统消息
function showMessage(message, type, callback) {
	var callback = callback || function () {};

	var popup = $('<div class="message"></div>')
		.text(message).addClass(type).hide()
		.appendTo($('div.trashbox'));

	popup
		.css({ left: ($(window).width() - popup.width() ) / 2 + 'px' })
		.fadeIn('fast');

	setTimeout(function () {
		popup.fadeOut('fast', callback);
	}, 3000);
}

// 页面加载后自动抽取NID
$(document).ready(function () {
	$('#submit').click(submitItems);
	$('#extract').click(addItems);
});

</script>

<div class="trashbox">

	<div class="header">
		<a href="javascript:void(0)" id="extract" class="button">抽取宝贝</a>
		<textarea id="memo" placeholder="请输入下架这些宝贝的原因"></textarea>
		<a href="javascript:void(0)" id="submit" class="button current">下架所有</a>
	</div>

	<table class="datalist" id="datalist" style="display:none;">
		<thead>
			<tr>
				<th width="18%">宝贝NID</th>
				<th width="60%">宝贝标题</th>
				<th width="22%">操作</th>
			</tr>
		</thead>
		<tbody>
		</tbody>
	</table>

	<p class="footer">宝贝下架助手 v1.0 by <a href="mailto:wangshijun2010@gmail.com">wangshijun2010@gmail.com</a></p>

</div>

</body>
</html>